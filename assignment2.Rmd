####Assignment 2 

```{r}
library(shiny)
library(mapgl)
library(here)
library(sf)
library(viridis)
library(tidyverse)
library(scales)

# ---- Load your data ----
county_data <- st_read(here("county_data.gpkg"))

# Ensure geometry is properly set and projected
county_data <- county_data %>%
  filter(!st_is_empty(geom)) %>%
  st_transform(4326) %>%
  filter(language != "Total")

# Create list of available languages (excluding "Total")
available_languages <- county_data %>%
  filter(!is.na(language), language != "Total") %>%
  pull(language) %>%
  unique() %>%
  sort()

# ---- UI ----
ui <- fluidPage(
  titlePanel("Language Speakers by County"),

  sidebarLayout(
    sidebarPanel(
      selectInput(
        inputId = "language",
        label = "Select a Language:",
        choices = available_languages,
        selected = available_languages[1]
      )
    ),
    mainPanel(
      maplibreOutput("map", height = "600px")
    )
  )
)

# ---- Server ----
server <- function(input, output, session) {

  filtered_data <- reactive({
    req(input$language)

    county_data %>%
      filter(language == input$language) %>%
      mutate(
        geoname = coalesce(geoname, "Unknown"),
        language = coalesce(language, "Unknown"),
        speakers = coalesce(speakers, 0),
        percent = coalesce(percent_speakers, 0),
        popup_text = paste0(
          "<strong>", geoname, "</strong><br/>",
          "Language: ", language, "<br/>",
          "Speakers: ", formatC(speakers, format = "d", big.mark = ","), "<br/>",
          "Percent: ", round(percent, 2), "%"
        )
      )
  })

  output$map <- renderMaplibre({
    data <- filtered_data()
    req(nrow(data) > 0)

    maplibre(style = carto_style("positron")) %>%
      fit_bounds(data, animate = FALSE) %>%
      add_fill_layer(
        id = "language_layer",
        source = data,
        fill_color = interpolate(
          column = "percent",
          values = c(0, 7, 14, 21, 28, 35, 42),
          stops = magma(7),
          na_color = "lightgray"
        ),
        fill_opacity = 0.8,
        popup = "popup_text"
      ) %>%
      add_legend(
        legend_title = "Percent Speakers",
        values = c(0, 7, 14, 21, 28, 35, 42),
        colors = magma(7),
        type = "continuous",
        position = "top-left"
      )
  })
}

# ---- Run the App ----
shinyApp(ui = ui, server = server)

```

